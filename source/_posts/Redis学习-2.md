---
title: Redis学习-2
date: 2020-09-14 19:32:40
tags: Redis 
categories: 设计原理
copyright:
---

# 深入理解Redis

## Redis阻塞

> **Redis 是典型的单线程架构**，所有的读写操作都是在一条主线程中完成的。当Redis用于高并发场景时，阻塞问题至关重要。

### 导致阻塞的原因

- 内在原因：不合理地使用API或数据结构、CPU饱和、持久化阻塞等
- 外在原因：CPU竞争、内存交换、网络问题等

#### CPU饱和

 **单线程的Redis处理命令时只能使用一个CPU**，CPU饱和是指Redis把单核CPU使用率跑到接近100%。CPU饱和导致Redis无法处理更多命令。

 解决方法有：
 - 采用集群分摊OPS压力（Operations per Second）
 - 检查是否存在过度的内存优化，例如为了节省内存使用ziplist代替hash
 - 检查是否采用了高算法复杂度的命令

#### CPU竞争

- 进程竞争：当Redis与其它多核CPU密集型服务部署在一起，会出现竞争CPU资源的情况。
- 绑定CPU：**部署Redis时为了充分利用多核CPU，通常一台机器会部署多个实例。常见的一种优化是把Redis进程绑定到CPU上，用于降低CPU频繁上下文切换的开销。**
    - 但是当Redis父进程创建子进程进行持久化时，如果作了CPU绑定，子进程与父进程就会在同一个CPU上进行，从而使得子进程与父进程抢夺CPU资源。**因此对于开启了持久化或参与复制的主节点不建议绑定CPU。**

## Redis内存

- Redis实际内存消耗主要包括：键值对象、缓冲区内存、内存碎片。
  - 缓冲内存包括：客户端缓冲、复制积压缓冲、AOF缓冲区 

## Redis事件处理

Redis服务器是典型的事件驱动程序。其中，事件分为文件事件和时间事件，事件封装在结构体*aeEventLoop*中。

Redis底层使用4中I/O多路复用模型（evport, select, kqueue, epoll），并对这4种模型进一步封装。

事件循环执行函数的主要逻辑：
- 查找最早会发生的时间事件，计算超时时间
- 阻塞等待文件事件的产生
- 处理文件事件
- 处理时间事件

### 文件事件

Redis客户端通过TCP socket与服务端交互，文件事件指的就是socket的可读可写事件。为了同时处理多条网络连接，采用较为成熟的I/O多路复用模型。


#### epoll

> epoll是linux内核为处理大量并发网络连接而提出的解决方案，能显著提升系统CPU利用率。

- epoll_create: 创建一个epoll专用的文件描述符
- epoll_ctl: 注册、修改或删除需要监控的事件
- epoll_wait: 阻塞进程知道监控的若干网络连接有事件发生

### 时间事件

本质上，Redis只有一个时间事件——serverCron。该函数实现了Redis服务器所有定时任务的周期执行。

## Redis Server启动过程

### Server初始化

**参考文献**
- 《Redis开发与运维》
- 《Redis 5设计与源码分析》